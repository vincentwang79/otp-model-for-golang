# 增强特征工程 - OTP检测模型

本文档描述了OTP短信检测模型中的增强特征工程实现。

## 主要改进

增强特征工程在以下几个方面进行了改进：

1. **增强数字模式识别特征**
   - 添加了多种数字模式识别，包括4位、5位、6位、8位数字
   - 识别带分隔符的数字模式（如123-456）
   - 识别括号中的数字（如[123456]）
   - 识别冒号后的数字（如code: 123456）
   - 计算数字在文本中的比例，并离散化为高、中、低三个级别

2. **调整OTP关键词列表及其权重**
   - 扩展关键词列表，增加更多OTP相关词汇
   - 为每个关键词分配权重，反映其对OTP判断的重要性
   - 根据权重重复添加关键词特征，增强其影响

3. **多语言支持**
   - 添加对中文、俄语、爱沙尼亚语的专门支持
   - 为每种语言创建专门的关键词列表
   - 实现语言检测功能，自动识别消息语言

4. **优化n-gram特征**
   - 扩展到3-gram特征，捕捉更长的词组模式
   - 增加特征数量，从2000增加到3000
   - 优化min_df和max_df参数，减少噪声特征

## 技术实现

### 语言检测

使用`langdetect`库和自定义规则进行语言检测：
- 英文 (en)
- 中文 (zh)
- 俄语 (ru)
- 爱沙尼亚语 (et)
- 其他语言 (other)

如果`langdetect`检测失败，则根据特定字符（如汉字、西里尔字母、爱沙尼亚语特殊字符）进行判断。

### 数字模式特征

实现了多种数字模式识别正则表达式，包括：
```python
DIGIT_PATTERNS = {
    "has_4_digits": r"\b\d{4}\b",
    "has_5_digits": r"\b\d{5}\b",
    "has_6_digits": r"\b\d{6}\b",
    "has_8_digits": r"\b\d{8}\b",
    "has_consecutive_digits": r"\d{2,}",
    "has_digits_with_separator": r"\d+[\s\-\.]+\d+",
    "has_digits_in_brackets": r"[\[\(（【]\s*\d+\s*[\]\)）】]",
    "has_digits_after_colon": r"[:：]\s*\d+",
    "has_digits_with_prefix": r"[a-zA-Z]+\d+",
    "digits_percentage": None,  # 特殊处理，计算数字在文本中的比例
}
```

### 多语言关键词

为每种语言定义了专门的OTP关键词列表及其权重：
- 英语：verification, code, otp, one-time, password等
- 中文：验证码, 验证, 密码, 一次性, 有效期等
- 俄语：код, подтверждения, пароль, одноразовый等
- 爱沙尼亚语：kood, kinnituskood, parool, ühekordne等

### 特征提取流程

1. 检测消息语言
2. 清洗文本（去除标点符号，标准化空格等）
3. 提取数字模式特征
4. 提取关键词特征，根据权重重复添加
5. 添加语言标识特征
6. 构建特征字符串，用于向量化

## 模型训练

支持三种模型类型：
- SVM (svm)：线性SVM分类器
- 朴素贝叶斯 (nb)：多项式朴素贝叶斯分类器
- 随机森林 (rf)：随机森林分类器

## 决策阈值优化

通过F1分数优化决策阈值：
1. 在验证集上计算不同阈值下的F1分数
2. 选择F1分数最高的阈值作为最佳决策阈值
3. 将最佳阈值保存到模型参数中

## 使用方法

### 训练增强特征工程模型

```bash
python src/python/train_validate_enhanced_models.py --model-types svm,nb,rf
```

### 在Go中使用增强特征工程模型

```bash
cd test/enhanced_cli
go run main.go -type nb
```

## 性能评估

增强特征工程模型在验证集上的性能评估结果：

| 模型 | 准确率 | 精确率 | 召回率 | F1分数 | 最佳阈值 |
|-----|-------|-------|-------|-------|--------|
| SVM | 待填充 | 待填充 | 待填充 | 待填充 | 待填充 |
| NB  | 待填充 | 待填充 | 待填充 | 待填充 | 待填充 |
| RF  | 待填充 | 待填充 | 待填充 | 待填充 | 待填充 |

*注：具体数值将在训练完成后填充* 