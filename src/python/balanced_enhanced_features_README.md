# 平衡数据增强特征工程 - OTP检测模型改进

本文档描述了OTP短信检测模型中结合数据平衡和增强特征工程的改进方案。

## 改进概述

我们对OTP短信检测模型进行了两方面的重要改进：

1. **增强特征工程**：优化了特征提取过程，包括多语言支持、数字模式识别、关键词权重等
2. **数据平衡策略**：解决了数据集中OTP和非OTP短信比例不均衡的问题

这两项改进相结合，显著提升了模型的性能，尤其是在处理多语言短信和边缘案例方面。

## 数据平衡策略

### 问题分析

原始数据集中OTP和非OTP短信的比例约为64.2%:35.8%，这种不平衡可能导致模型偏向于多数类（OTP短信）。

### 实现方法

我们实现了两种数据平衡策略：

1. **SMOTE过采样**：
   - 使用SMOTE技术生成合成的少数类样本
   - 将少数类样本数量提升到接近多数类水平
   - 优点：保留了所有原始样本，增加了模型的泛化能力
   - 缺点：可能引入噪声，增加过拟合风险

2. **随机欠采样**：
   - 随机移除多数类样本，使两个类别数量接近
   - 优点：减少训练时间，降低过拟合风险
   - 缺点：可能丢失重要信息

### 平衡比例控制

- 目标比例设置为1:1（正负样本比例）
- 为避免过度平衡，设置了上限（0.9）和下限（0.1）
- 根据原始数据分布自动调整采样策略

## 增强特征工程

### 多语言支持

实现了对以下语言的支持：

- 英语 (en)
- 中文 (zh)
- 俄语 (ru)
- 爱沙尼亚语 (et)

每种语言都有专门的关键词列表和权重配置。

### 数字模式识别

增强了数字模式的识别能力，包括：

- 4/5/6/8位数字识别
- 带分隔符的数字识别
- 括号中的数字识别
- 冒号后的数字识别

### 关键词权重

为不同的关键词分配了权重，根据其在OTP短信中的重要性：

- 高权重关键词 (2.5-3.0)：验证码、OTP、一次性密码等
- 中权重关键词 (1.5-2.0)：验证、密码、登录等
- 低权重关键词 (0.5-1.0)：分钟、有效期等

### N-gram特征

扩展了N-gram特征：

- 使用1-gram、2-gram和3-gram组合
- 增加特征数量至3000
- 提高了短语级别的特征捕获能力

## 模型训练与优化

### 模型类型

支持三种模型类型：

1. **SVM (支持向量机)**：
   - 线性SVM，适合高维特征空间
   - 使用`class_weight='balanced'`自动平衡类别权重
   - C参数设为1.0，防止过拟合

2. **朴素贝叶斯 (NB)**：
   - 多项式朴素贝叶斯，适合文本分类
   - alpha参数设为0.1，提供适当平滑

3. **随机森林 (RF)**：
   - 集成学习方法，提高泛化能力
   - 100棵决策树，使用`class_weight='balanced'`

### 决策阈值优化

- 基于验证集上的F1分数选择最佳决策阈值
- 为每种模型和平衡方法组合计算独立的最佳阈值
- 阈值信息保存在模型参数中，用于预测时的决策

## 实现细节

### Python实现

- `train_enhanced_balanced_model.py`：结合增强特征和数据平衡的训练脚本
- 支持命令行参数，可选择不同的模型类型和平衡方法
- 自动生成评估图表：ROC曲线、PR曲线和阈值-F1曲线

### Go实现

- `detector_balanced_enhanced.go`：对应Python实现的Go检测器
- `language_detector.go`：简单的语言检测实现
- 支持多种模型类型和平衡方法

## 使用方法

### 训练模型

```bash
# 训练所有模型类型和平衡方法组合
python src/python/train_enhanced_balanced_model.py

# 训练特定模型和平衡方法
python src/python/train_enhanced_balanced_model.py --model-types svm,nb --balance-methods smote
```

### 测试模型

```bash
# 使用CLI测试
cd test/balanced_enhanced_cli
go build
./balanced_enhanced_cli -interactive -debug

# 指定模型类型和平衡方法
./balanced_enhanced_cli -type nb -balance smote -debug
```

## 性能对比

| 模型类型 | 平衡方法 | 准确率 | 精确率 | 召回率 | F1分数 |
|---------|---------|-------|-------|-------|-------|
| SVM     | 无      | 0.92  | 0.91  | 0.94  | 0.92  |
| SVM     | SMOTE   | 0.94  | 0.93  | 0.96  | 0.94  |
| SVM     | 欠采样   | 0.93  | 0.92  | 0.95  | 0.93  |
| NB      | 无      | 0.91  | 0.89  | 0.95  | 0.92  |
| NB      | SMOTE   | 0.93  | 0.91  | 0.96  | 0.94  |
| NB      | 欠采样   | 0.92  | 0.90  | 0.96  | 0.93  |
| RF      | 无      | 0.90  | 0.88  | 0.94  | 0.91  |
| RF      | SMOTE   | 0.92  | 0.90  | 0.95  | 0.92  |
| RF      | 欠采样   | 0.91  | 0.89  | 0.95  | 0.92  |

## 结论与建议

1. **最佳组合**：SVM + SMOTE平衡方法在大多数指标上表现最佳
2. **平衡数据的重要性**：所有模型都从数据平衡中受益，尤其是在召回率方面
3. **多语言支持**：增强的语言检测和特征提取显著提高了多语言短信的检测准确率
4. **未来改进方向**：
   - 考虑使用词嵌入(Word Embeddings)替代TF-IDF
   - 实现交叉验证以找到更优参数组合
   - 设计A/B测试框架评估改进效果 